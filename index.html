<!DOCTYPE html>

<html>

<head>
    <meta charset="UTF-8">
    <title>Todo Today</title>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
        }

        .full {
            width: 100%;
        }

        #todo-container {
            list-style-type: none;
            margin: 0;
            padding: 0;
        }

        .todo {
            background-color: #f1f1f1;
            box-sizing: border-box;
            padding: 1em;
            margin: 0.5em;
            border-radius: 4px;
        }

        .todo h1 {
            margin: 0px;
        }

        #todo-controls-container {
            /*position: fixed;
            bottom: 0.5em;
            right: 0.5em;*/
            display: block;
            margin: 0.5em;
            background-color: turquoise;
            box-sizing: border-box;
            padding: 0.5em;
            border-radius: 4px;
        }

        #todo-controls-container > div {
            display: block;
        }

        #controls-toggler {
            position: fixed;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            bottom: 2em;
            right: 1em;
            display: block;
            border: none;
            background-color: turquoise;
            z-index: 1;
            cursor: pointer;
            color: white;
        }

        /*TODO: Remove button depression animation.*/

        #controls-toggler:active {
            background-color: red;
            border: none;
        }
    </style>
</head>

<body>
    <div class="full">
        <ul id="todo-container">
            <!-- Todos go here. -->
        </ul>
        <div id="todo-controls-container">
            <div>
                <input type="text" id="title-input">
                <input type="text" id="description-input">
            </div>
            <div>
                <button id="create-todo-button">Create Todo</button>
                <button id="delete-all-todos-button">Delete All Todos</button>
                <button id="reset-all-todos-button">Reset All Todos</button>
            </div>
        </div>
        <button id="controls-toggler">+</button>
        <!-- Actually get this to work. -->
    </div>

    <script>

        /*
            TODO:
            * Sort todos (use flex and order?)
            * Edit todos
            * Dismiss Todo using swipe
            * Date functions of Todos
                * compare not just day, but also month and year
            * Todo colors
            * Settings (char select)
            * Score system
        */

        document.addEventListener("DOMContentLoaded", (event) => {
            let createTodoButton = document.getElementById("create-todo-button");

            createTodoButton.addEventListener("click", (event) => {
                let titleInput = document.getElementById("title-input");
                let descriptionInput = document.getElementById("description-input");

                let title = titleInput.value;
                let description = descriptionInput.value;

                todoManager.createTodo(title, description);

                titleInput.value = "";
                descriptionInput.value = "";

                todoManager.loadTodos(renderTodo);
            }, false);

            let deleteAllTodosButton = document.getElementById("delete-all-todos-button");

            deleteAllTodosButton.addEventListener("click", () => {
                while (document.getElementsByClassName("todo").length > 0) {
                    document.getElementsByClassName("todo")[0].remove();
                }
                todoManager.deleteAllTodos();
            }, false);

            let resetAllTodosButton = document.getElementById("reset-all-todos-button");

            resetAllTodosButton.addEventListener("click", () => {
                todoManager.resetAllTodos();
                todoManager.loadTodos(renderTodo);
            }, false);

        }, false);

        function renderTodo(todo) {

            if (todo.complete == false) {

                let todoContainer = document.getElementById("todo-container");

                let todoElement = document.createElement("LI");
                todoElement.className = "todo";
                todoElement.id = "todo-" + todo.title;

                let title = document.createElement("H1");
                title.innerText = todo.title;

                let description = document.createElement("P");
                description.innerText = todo.description;

                let deleteTodoButton = document.createElement("BUTTON");
                deleteTodoButton.innerText = "X";

                let dismissTodoButton = document.createElement("BUTTON");
                dismissTodoButton.innerText = "-";

                deleteTodoButton.addEventListener("click", () => {
                    todoManager.deleteTodo(todo.title);
                    document.getElementById(todoElement.id).remove();
                }, false);

                dismissTodoButton.addEventListener("click", () => {
                    todoManager.dismissTodo(todo.title);
                    document.getElementById(todoElement.id).remove();
                }, false);

                todoElement.appendChild(title);
                todoElement.appendChild(description);
                todoElement.appendChild(deleteTodoButton);
                todoElement.appendChild(dismissTodoButton);
                todoContainer.appendChild(todoElement);
            }
        }

        function Todo(title, description) {
            this.title = title;
            this.description = description;
            this.complete = false;

            // Maybe not needed:
            this.update = (property, value) => {
                this[property] = value;
            };
        }

        // An index of non-to-do items to be stored in local storage.
        let reservedItems = {
            "last-access-date": /*new Date().getDate(),*/ true,
            "getLength": () => {
                let length = 0;
                for(item in reservedItems){
                    if(reservedItems.hasOwnProperty(item) && item != "getLength"){
                        length++;
                    }
                }
                return length;
            }
        }

        let todoManager = {
            createTodo: (title, description) => {
                localStorage.setItem(title, JSON.stringify(new Todo(title, description)));
            },

            deleteTodo: (title) => {
                localStorage.removeItem(title);
            },
            // Write todo upkeep. set Todo.complete: false
            dismissTodo: (title) => {
                let todo = JSON.parse(localStorage.getItem(title));
                todo.complete = true;
                localStorage.setItem(title, JSON.stringify(todo));
            },

            loadedTodos: {},

            // Takes callback function to process each todo's data.
            // Callback: (todo) => {} 
            // Let the callback filter the todos
            loadTodos: (cb) => {
                if (localStorage && localStorage.length > reservedItems.getLength() && typeof cb == "function") {
                    for (let item in localStorage) {
                        if (localStorage.getItem(item) && !reservedItems[item]) {
                            let todo = JSON.parse(localStorage.getItem(item));

                            if (!todoManager.loadedTodos[todo.title]) {
                                cb(todo);
                                todoManager.loadedTodos[todo.title] = todo;
                            }
                        }
                    }
                } else if (localStorage.length <= reservedItems.getLength()) {
                    alert("Local Storage is empty.");
                } else if (typeof cb != "function") {
                    alert("Callback is not a function.");
                } else {
                    alert("Local Storage does not exist!");
                }
            },

            // JANK AF
            resetAllTodos: () => {
                if (localStorage && localStorage.length > reservedItems.getLength()) {
                    for (let item in localStorage) {
                        if (localStorage.getItem(item) && !reservedItems[item]) {
                            let todo = JSON.parse(localStorage.getItem(item));

                            if (todoManager.loadedTodos[todo.title]) {
                                if (todo.complete == true) {
                                    delete todoManager.loadedTodos[todo.title];
                                }
                            }

                            todo.complete = false;
                            localStorage.setItem(todo.title, JSON.stringify(todo));
                        }
                    }
                } else if (localStorage.length <= reservedItems.getLength()) {
                    alert("Local Storage is empty.");
                } else if (typeof cb != "function") {
                    alert("Callback is not a function.");
                } else {
                    alert("Local Storage does not exist!");
                }
            },

            // TODO: Revamp to avoid deleting reserved items.
            deleteAllTodos: () => {
                if (localStorage && localStorage.length > reservedItems.getLength()) {
                    for (let item in localStorage) {
                        if (localStorage.getItem(item) && !reservedItems[item]) {
                            localStorage.removeItem(item);
                        }
                    }
                } else if (localStorage.length <= reservedItems.getLength()) {
                    alert("Local Storage is empty.");
                } else if (typeof cb != "function") {
                    alert("Callback is not a function.");
                } else {
                    alert("Local Storage does not exist!");
                }
            }
        }

        let lastAccessDate = localStorage.getItem("last-access-date");
        let currentDate;

        if (!lastAccessDate) {
            console.log("No last-access-date.");
            localStorage.setItem("last-access-date", new Date().toDateString());
            lastAccessDate = localStorage.getItem("last-access-date");
            console.log("Set last-access-date.");
            console.log("Last access date:", localStorage.getItem("last-access-date"));
        }

        setInterval(() => {
            currentDate = new Date();

            if (lastAccessDate != currentDate.toDateString()) {

                console.log("A new day has dawned.");

                lastAccessDate = currentDate.toDateString();
                localStorage.setItem("last-access-date", currentDate.toDateString());
                console.log("Updated last-access-date.");

                todoManager.resetAllTodos();
                console.log("Reset todos.");
                todoManager.loadTodos(renderTodo);
                console.log("Todos reloaded.");
            }
        }, 1000);

        console.log("localStorage:", localStorage);
        todoManager.loadTodos(renderTodo);
    </script>
</body>

</html>